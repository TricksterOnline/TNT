# NORI Format Specification

<pre>
Copyright (C) 2014-2024 Libre Trickster Team

Note: All sizes throughout the specification are measured in bytes.

Okay, before we get to covering the NORI file format you have to deal with the
fact that some NORI files come compressed with the zlib DEFLATE algorithm. So
you have to first check for and INFLATE any files that come this way before you
can move on to reading the normal NORI info.(ex: Taiwan's map_sq00_event01.bac)

The file will look this if compressed by zlib:
</pre><pre>
+------------------------------------------------------------------------------+
| Compression: zlib Compression (DEFLATE Algorithm)                            |
+-----------------+-----+------------------------------------------------------+
| Name            |Bytes| Description                                          |
+-----------------+-----+------------------------------------------------------+
| Fake header     |  4  | Fake file hdr; bit of joke: 0xB0A0 (BA = Byte Array) |
+-----------------+-----+------------------------------------------------------+
| Actual size     |  4  | Data size after decompression                        |
+-----------------+-----+------------------------------------------------------+
| Data size       |  4  | Data size before decompression (includes zlib header)|
+-----------------+-----+------------------------------------------------------+
| zlib header     |  2  | Magic bytes: 0x78XX (XX can be 01, 9C, or DA)        |
+-----------------+-----+------------------------------------------------------+
| Compressed data |  *  | Decompress using the INFLATE algorithm               |
+-----------------+-----+------------------------------------------------------+
+------------------------------------------------------------------------------+
</pre><pre>
After zlib INFLATE or if uncompressed to begin with, you can start reading the
NORI file as it is suppose to look:
</pre><pre>
+------------------------------------------------------------------------------+
| NORI Header                                                        (40 Bytes)|
+--------------+-----+---------------------------------------------------------+
| Name         |Bytes| Description                                             |
+--------------+-----+---------------------------------------------------------+
| signature    |  4  | NORI file signature                                     |
+--------------+-----+---------------------------------------------------------+
| version      |  4  | NORI format version (300, 301, 302, 303)                |
+--------------+-----+---------------------------------------------------------+
| nParam1      |  4  | Unidentified data (ex: majority of mapbgeffect NORI)    |
+--------------+-----+---------------------------------------------------------+
| nParam2      |  4  | Unidentified data (ex: majority of mapbgeffect NORI)    |
+--------------+-----+---------------------------------------------------------+
| nParam3      |  4  | Unidentified data (ex: majority of mapbgeffect NORI)    |
+--------------+-----+---------------------------------------------------------+
| nParam4      |  4  | Unidentified data (ex: majority of mapbgeffect NORI)    |
+--------------+-----+---------------------------------------------------------+
| nParam5      |  4  | Unidentified data (ex: majority of mapbgeffect NORI)    |
+--------------+-----+---------------------------------------------------------+
| anims        |  4  | Number of included animations                           |
+--------------+-----+---------------------------------------------------------+
| withoutGawi  |  4  | fsize - GAWI Section size  (i.e. w/o Gawi -> woGawi)    |
+--------------+-----+---------------------------------------------------------+
| fsize        |  4  | NORI file size                                          |
+--------------+-----+---------------------------------------------------------+
+------------------------------------------------------------------------------+
| END OF NORI HEADER                                                           |
+------------------------------------------------------------------------------+
+------------------------------------------------------------------------------+
| GAWI SECTION                                                                 |
+------------------------------------------------------------------------------+
+------------------------------------------------------------------------------+
| GAWI Header                                                        (44 Bytes)|
+--------------+-----+---------------------------------------------------------+
| Name         |Bytes| Description                                             |
+--------------+-----+---------------------------------------------------------+
| signature    |  4  | 'GAWI' Identifier of the GAWI section                   |
+--------------+-----+---------------------------------------------------------+
| version      |  4  | Version of the GAWI section format (always 300)         |
+--------------+-----+---------------------------------------------------------+
| bpp          |  4  | Bit depth of the images (8, 16, or 24)                  |
+--------------+-----+---------------------------------------------------------+
| compressed   |  4  | Image compression flag (1 is yes) (RLE compression)     |
+--------------+-----+---------------------------------------------------------+
| hasPalette   |  4  | Palette usage flag (set to 1, if palette exists)        |
+--------------+-----+---------------------------------------------------------+
| gParam4      |  4  | Unidentified data (ex: majority of mapbgeffect NORI)    |
+--------------+-----+---------------------------------------------------------+
| gParam5      |  4  | Unidentified data (ex: majority of mapbgeffect NORI)    |
+--------------+-----+---------------------------------------------------------+
| gParam6      |  4  | Unidentified data (ex: majority of mapbgeffect NORI)    |
+--------------+-----+---------------------------------------------------------+
| gParam7      |  4  | Unidentified data (ex: majority of mapbgeffect NORI)    |
+--------------+-----+---------------------------------------------------------+
| bmpStructs   |  4  | Number of BMP structures                                |
+--------------+-----+---------------------------------------------------------+
| gsize        |  4  | Size of entire GAWI section                             |
+--------------+-----+---------------------------------------------------------+
+------------------------------------------------------------------------------+
| END OF GAWI HEADER                                                           |
+------------------------------------------------------------------------------+
+------------------------------------------------------------------------------+
| Palette Data: Palette Section (may or may not exist)       (800 or 808 Bytes)|
+--------------+-----+---------------------------------------------------------+
| Name         |Bytes| Description                                             |
+--------------+-----+---------------------------------------------------------+
| signature    |  4  | 'PAL_' Identifier of palette structure                  |
+--------------+-----+---------------------------------------------------------+
| version      |  4  | Version of the PAL_ section format (always 100)         |
+--------------+-----+---------------------------------------------------------+
| pParam_01-04 | 16  | Unidentified data                                       |
+--------------+-----+---------------------------------------------------------+
| divided      |  4  | T/F flag for whether pal is divided into 2 sections.    |
|              |     | They are:[base]&[main]; if =1, mainStart & mainEnd exist|
+--------------+-----+---------------------------------------------------------+
| psize        |  4  | size of entire palette section                          |
+--------------+-----+---------------------------------------------------------+
| [RGB24DATA]  | 768 | raw palette data; see BitmapData                        |
+--------------+-----+---------------------------------------------------------+
+--------------+-----+---------------------------------------------------------+
| mainStart    |  4  | Palette index # that is the start of [main] section.    |
|              |     | Standard value is 111. palette[111]                     |
+--------------+-----+---------------------------------------------------------+
| mainEnd      |  4  | Palette index # that is the end of [main] section.      |
|              |     | Standard value is 254. palette[254]                     |
+--------------+-----+---------------------------------------------------------+
+------------------------------------------------------------------------------+
| END OF PALETTE DATA                                                          |
+------------------------------------------------------------------------------+
+------------------------------------------------------------------------------+
| BMP Offsets                                                                  |
+--------------+-----+---------------------------------------------------------+
| Name         |Bytes| Description                                             |
+--------------+-----+---------------------------------------------------------+
| bmpOffsets   | bos | BMP 1st byte locations; bos=(4)(numBMP); If compressed  |
|              |     | by RLE, add (28)(n) to each location; n=0,n++ each time |
+--------------+-----+---------------------------------------------------------+
+------------------------------------------------------------------------------+
| END OF BMP OFFSETS                                                           |
+------------------------------------------------------------------------------+
+------------------------------------------------------------------------------+
| BitmapData: BMP Data For Each Image             (4+(bmp_count)(sod+24) Bytes)|
+--------------+-----+---------------------------------------------------------+
| Name         |Bytes| Description                                             |
+--------------+-----+---------------------------------------------------------+
| bmp_count    |  4  | When >1, img subset exists, subs lack a bmpOffset value |
|              |     | When =0, the BitmapData section & this var do not exist |
+--------------+-----+---------------------------------------------------------+
+--------------+-----+---------------------------------------------------------+
| data_length  |  4  | data size(=sod)                                         |
+--------------+-----+---------------------------------------------------------+
| bmp_width    |  4  | Image width (in pixels)                                 |
+--------------+-----+---------------------------------------------------------+
| bmp_height   |  4  | Image height (in pixels)                                |
+--------------+-----+---------------------------------------------------------+
| bParam4      |  4  | Unidentified data (possibly a delay #)                  |
+--------------+-----+---------------------------------------------------------+
| bmp_x        |  4  | The image's X position, usually 0                       |
+--------------+-----+---------------------------------------------------------+
| bmp_y        |  4  | The image's Y position, usually 0                       |
+--------------+-----+---------------------------------------------------------+
|[RGB24Data]   | sod | 24bit img; bit fmt: B8G8R8 (3Bytes)                     |
|[RGB16Data]   | sod | 16bit img; bit fmt: R5G5B5 [nRRRRRGG GGGBBBBB] (2Bytes) |
|[PalIndexData]| sod |  8bit img; bit fmt: 1 index # = 1 unsigned byte         |
+--------------+-----+---------------------------------------------------------+
+------------------------------------------------------------------------------+
| END OF BMP DATA                                                              |
+------------------------------------------------------------------------------+
+------------------------------------------------------------------------------+
| END OF GAWI SECTION                                                          |
+------------------------------------------------------------------------------+
+------------------------------------------------------------------------------+
| AnimOffsetData: Animation Offset Address Info                                |
+--------------+-----+---------------------------------------------------------+
| Name         |Bytes| Description                                             |
+--------------+-----+---------------------------------------------------------+
| animOffsets  | aos | Animation first byte locations, aos = (4)(anims)        |
+--------------+-----+---------------------------------------------------------+
</pre><pre>
The next 4 sections are cyclical and can exist in multiples asymmetrically.
The AnimData, FrameDataTop, PlaneData, and FrameDataBottom section.
They are structured visually like this:
</pre>
* AnimData
    - FrameDataTop
        - PlaneData
    - FrameDataBottom

<pre>
+------------------------------------------------------------------------------+
| AnimData: For Each Animation                                   (fos+36 Bytes)|
+--------------+-----+---------------------------------------------------------+
| Name         |Bytes| Description                                             |
+--------------+-----+---------------------------------------------------------+
| title        | 32  | Animation title (uses EUC-KR encoding)                  |
+--------------+-----+---------------------------------------------------------+
| numFrames    |  4  | Number of frames(=nof)                                  |
+--------------+-----+---------------------------------------------------------+
| frameOffsets | fos | Frame first byte locations, fos = (4)(nof)              |
+--------------+-----+---------------------------------------------------------+
+------------------------------------------------------------------------------+
| FrameDataTop: For Each Frame                                        (8 Bytes)|
+--------------+-----+---------------------------------------------------------+
| Name         |Bytes| Description                                             |
+--------------+-----+---------------------------------------------------------+
| duration     |  4  | Duration of this frame (milliseconds)                   |
+--------------+-----+---------------------------------------------------------+
| numPlanes    |  4  | Number of planes(=nop)                                  |
+--------------+-----+---------------------------------------------------------+
+------------------------------------------------------------------------------+
| PlaneData: For Each Plane                                          (28 Bytes)|
+--------------+-----+---------------------------------------------------------+
| Name         |Bytes| Description                                             |
+--------------+-----+---------------------------------------------------------+
| bmp_id       |  4  | BMP ID number for plane (# from 0 to (numBMP-1))        |
+--------------+-----+---------------------------------------------------------+
| plane_x      |  4  | Location coordinates x                                  |
+--------------+-----+---------------------------------------------------------+
| plane_y      |  4  | Location coordinates y                                  |
+--------------+-----+---------------------------------------------------------+
| opacity      |  4  | Always 100, as in 100%, from what I've seen             |
+--------------+-----+---------------------------------------------------------+
| flip         |  4  | How to flip img;0=none,1=horiz,2=vert,3=(horiz & vert)  |
+--------------+-----+---------------------------------------------------------+
| blend_mode   |  4  | ADD, MULTY, INVMULTY, etc                               |
+--------------+-----+---------------------------------------------------------+
| flag_param   |  4  | Seen 14,15,16,& 32; a flag for something                |
+--------------+-----+---------------------------------------------------------+
+------------------------------------------------------------------------------+
| FrameDataBottom: For Each Frame              (size varies for each animation)|
+--------------+-----+---------------------------------------------------------+
| Name         |Bytes| Description                                             |
+--------------+-----+---------------------------------------------------------+
| numCoordSets |  4  | # of following coord sets, does not exist in NORI v300  |
+--------------+-----+---------------------------------------------------------+
+--------------+-----+---------------------------------------------------------+
| coord_x      |  4  | x coordinate, may not exist, if v300 it won't exist     |
+--------------+-----+---------------------------------------------------------+
| coord_y      |  4  | y coordinate, may not exist, if v300 it won't exist     |
+--------------+-----+---------------------------------------------------------+
+--------------+-----+---------------------------------------------------------+
| cdBlock      | cds | CD bytes, cds=144 (v300,v301), cds=96 (v302,v303)       |
+--------------+-----+---------------------------------------------------------+
| entryBlocks  | ebs | ebs=28*6; currently stored base64; absent in v300 & v301|
+--------------+-----+---------------------------------------------------------+
| UnknownData1 | 44  | some type of data; currently XML-stored as base64       |
+--------------+-----+---------------------------------------------------------+
| soundEffect  | 18  | sound effect for frame; assumes file is in sound folder |
+--------------+-----+---------------------------------------------------------+
| UnknownData2 | 18  | some more unknown data; currently XML-stored as base64  |
+--------------+-----+---------------------------------------------------------+
| hasMCValues  |  4  | When =1, MyCamp section exists; this var is v303 only   |
+--------------+-----+---------------------------------------------------------+
+--------------+-----+---------------------------------------------------------+
| mcParam0     |  4  | Unidentified data, usually 0                            |
+--------------+-----+---------------------------------------------------------+
| mcParam1     |  4  | Unidentified data, related to mcParam7                  |
+--------------+-----+---------------------------------------------------------+
| mcParam2     |  4  | Unidentified data, related to mcParam7                  |
+--------------+-----+---------------------------------------------------------+
| mcParam3     |  4  | Unidentified data, usually 8                            |
+--------------+-----+---------------------------------------------------------+
| mcParam4     |  4  | Unidentified data, usually 8                            |
+--------------+-----+---------------------------------------------------------+
| mcParam5     |  4  | Unidentified data (could be a width param)              |
+--------------+-----+---------------------------------------------------------+
| mcParam6     |  4  | Unidentified data (could be a length param)             |
+--------------+-----+---------------------------------------------------------+
| mcParam7     |  A  | Unidentified, A=(mcParam1 x mcParam2), stored base64    |
+--------------+-----+---------------------------------------------------------+
| mcParam8     | 20  | Unidentified data, currently XML-stored as base64       |
+--------------+-----+---------------------------------------------------------+
+------------------------------------------------------------------------------+
| END OF ANIMATION DATA                                                        |
+------------------------------------------------------------------------------+
+------------------------------------------------------------------------------+
| END OF FILE FORMAT                                                           |
+------------------------------------------------------------------------------+
</pre>
# ============= Additional Info =============

<pre>
Custom Run-length Encoding:
Each scanline is defined by a encodedSize, and a cycle of background and
foreground pixel data that is repeated until the encodedSize is met.
+------------------------------------------------------------------------------+
| Compression: Custom RLE Per Scanline (wikipedia.org/wiki/Run-length_encoding)|
+--------------+-----+---------------------------------------------------------+
| Name         |Bytes| Description                                             |
+--------------+-----+---------------------------------------------------------+
| encodedSize  |  2  | # of bytes to read for this scanline (includes itself)  |
+--------------+-----+---------------------------------------------------------+
+--------------+-----+---------------------------------------------------------+
| bg_pixels    |  2  | # of bg pixels; no color specified, you choose it       |
+--------------+-----+---------------------------------------------------------+
| fg_pixels    |  2  | # of actual foreground pixels that follow  (=fg)        |
+--------------+-----+---------------------------------------------------------+
| fg_data      | fgs | Actual foreground pixels.  fgs = (fg)(bpp/8)            |
+--------------+-----+---------------------------------------------------------+
</pre>
## FrameDataBottom: Extra Info

<pre>
1. CD block structure: Just a series of bytes with 0xCD value.

2. Entry block structure (total size: 28 bytes)
+------------------------------------------------------------------------------+
| Entry block structure                                                        |
+--------------+-----+---------------------------------------------------------+
| Name         |Bytes| Description                                             |
+--------------+-----+---------------------------------------------------------+
| eParam_00    |  4  | Value usually = 0xCDCDCDCD (probably unassigned data)   |
+--------------+-----+---------------------------------------------------------+
| eParam_01    |  4  | Unknown (usually null)                                  |
+--------------+-----+---------------------------------------------------------+
| eParam_x     |  4  | Probably X-value                                        |
+--------------+-----+---------------------------------------------------------+
| eParam_y     |  4  | Probably Y-value                                        |
+--------------+-----+---------------------------------------------------------+
| eParam_04    |  4  | Unknown (usually null)                                  |
+--------------+-----+---------------------------------------------------------+
| eParam_05    |  4  | Unknown (usually null)                                  |
+--------------+-----+---------------------------------------------------------+
| eParam_06    |  4  | Unknown (usually null)                                  |
+--------------+-----+---------------------------------------------------------+
Some map files such as "map_sq00.bac" (Megalopolis Square) are found to have
non-zero eParam_x and eParam_y for certain frames.
Examples:
- map_sq00.bac, eTO version (latest) - 0x8EA466
- map_sq00_event01.bac, Taiwan TO client (zlib compressed) - 0x8F939A
</pre>

